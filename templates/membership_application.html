{% extends "base.html" %}
{% block title %}Join Our Prayer Community{% endblock %}

{% block content %}
<!-- Membership Application Page Header -->
<section class="mb-8 text-center">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-4xl font-bold text-gray-900 dark:text-gray-100 mb-4">Join Our Prayer Community</h1>
    <p class="text-lg text-gray-600 dark:text-gray-300 mb-6">
      We'd love to have you join our faith-based community where we pray together, support one another, and experience God's love through authentic prayer and fellowship.
    </p>

    <!-- Community Features -->
    <div class="grid md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
        <div class="text-3xl mb-3">üôè</div>
        <h3 class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Scripture-Based Prayers</h3>
        <p class="text-gray-600 dark:text-gray-300 text-sm">AI-generated prayers rooted in Biblical wisdom and Christian faith</p>
      </div>
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
        <div class="text-3xl mb-3">ü§ù</div>
        <h3 class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Community Support</h3>
        <p class="text-gray-600 dark:text-gray-300 text-sm">Members pray for one another and share in life's joys and challenges</p>
      </div>
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm">
        <div class="text-3xl mb-3">üîí</div>
        <h3 class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Safe & Private</h3>
        <p class="text-gray-600 dark:text-gray-300 text-sm">Invite-only community with thoughtful moderation and respect</p>
      </div>
    </div>
  </div>
</section>

<!-- Application Form Section -->
<section class="mb-8">
  <div class="max-w-2xl mx-auto">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
      <div class="mb-6">
        <h2 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 mb-2">Membership Application</h2>
        <p class="text-gray-600 dark:text-gray-400">
          Tell us about yourself and why you'd like to join our prayer community. Applications are reviewed by our administrators.
        </p>
      </div>

      <form id="membership-form" onsubmit="submitApplication(event)">
        <!-- Username Field -->
        <div class="mb-6">
          <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Desired Username <span class="text-red-500">*</span>
          </label>
          <input type="text"
                 id="username"
                 name="username"
                 required
                 maxlength="50"
                 class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 dark:focus:ring-purple-400 dark:bg-gray-700 dark:text-white text-lg"
                 placeholder="Enter your desired username">
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">This will be your display name in the community</p>
        </div>

        <!-- Essay Field -->
        <div class="mb-6">
          <label for="essay" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Why do you want to join our prayer community? <span class="text-red-500">*</span>
          </label>
          <textarea id="essay"
                    name="essay"
                    required
                    rows="8"
                    maxlength="1000"
                    class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 dark:focus:ring-purple-400 dark:bg-gray-700 dark:text-white text-lg"
                    placeholder="Share your heart with us... What draws you to our community? How do you hope to contribute to and benefit from our prayer fellowship?"></textarea>
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400 flex justify-between">
            <span>Please share thoughtfully - this helps us understand your heart for community</span>
            <span id="essay-counter">0 / 1000 characters</span>
          </p>
        </div>

        <!-- Contact Info Field -->
        <div class="mb-8">
          <label for="contact" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Contact Information <span class="text-red-500">*</span>
          </label>
          <input type="text"
                 id="contact"
                 name="contact"
                 required
                 maxlength="100"
                 class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 dark:focus:ring-purple-400 dark:bg-gray-700 dark:text-white text-lg"
                 placeholder="Email or other contact method">
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Required so we can contact you if your application is approved</p>
        </div>

        <!-- Submit Button -->
        <div class="text-center">
          <button type="submit"
                  id="submit-btn"
                  class="bg-green-600 hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-800 text-white px-8 py-4 rounded-lg font-semibold text-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 dark:focus:ring-green-400 min-w-48">
            Submit Application
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<!-- Success Message (hidden initially) -->
<section id="success-section" class="hidden mb-8">
  <div class="max-w-2xl mx-auto">
    <div class="bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700 rounded-lg p-8 text-center">
      <div class="text-green-500 text-5xl mb-4">‚úì</div>
      <h2 class="text-2xl font-semibold text-green-800 dark:text-green-100 mb-4">Application Submitted!</h2>
      <p class="text-green-700 dark:text-green-200 mb-4">
        Thank you for your interest in joining our prayer community. Your application has been received and will be reviewed by our administrators.
      </p>

      <!-- Application ID Display -->
      <div class="bg-green-100 dark:bg-green-800 border border-green-300 dark:border-green-600 rounded-lg p-4 mb-4">
        <p class="text-sm text-green-600 dark:text-green-300 mb-1">Your Application ID:</p>
        <p class="text-lg font-mono font-bold text-green-800 dark:text-green-100" id="application-id">
          <!-- Will be populated by JavaScript -->
        </p>
        <p class="text-xs text-green-600 dark:text-green-400 mt-1">
          Save this ID - you can use it to check your application status at <a href="/apply/status" class="underline hover:text-green-800 dark:hover:text-green-200">/apply/status</a>
        </p>
      </div>

      <p class="text-green-600 dark:text-green-300 mb-6">
        You'll be contacted at the email address you provided if your application is approved. We appreciate your patience during the review process.
      </p>
      <a href="/" class="inline-block bg-white dark:bg-gray-800 text-green-600 dark:text-green-400 px-6 py-2 rounded-lg font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
        View Community Prayers
      </a>
    </div>
  </div>
</section>

<!-- Error Message (hidden initially) -->
<section id="error-section" class="hidden mb-8">
  <div class="max-w-2xl mx-auto">
    <div class="bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-700 rounded-lg p-8 text-center">
      <div class="text-red-500 text-5xl mb-4">‚ö†</div>
      <h2 class="text-2xl font-semibold text-red-800 dark:text-red-100 mb-4">Application Error</h2>
      <p class="text-red-700 dark:text-red-200 mb-6" id="error-text">
        There was a problem submitting your application. Please try again.
      </p>
      <button onclick="showApplicationForm()"
              class="inline-block bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
        Try Again
      </button>
    </div>
  </div>
</section>

<!-- Back to Community -->
<section class="text-center mb-8">
  <p class="text-gray-600 dark:text-gray-400 mb-4">
    Want to see what our community is about first?
  </p>
  <a href="/" class="text-purple-600 dark:text-purple-400 hover:text-purple-800 dark:hover:text-purple-200 font-medium">
    ‚Üê View Recent Community Prayers
  </a>
</section>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  setupApplicationForm();
});

function setupApplicationForm() {
  const essayField = document.getElementById('essay');
  const counter = document.getElementById('essay-counter');

  essayField.addEventListener('input', () => {
    const length = essayField.value.length;
    counter.textContent = `${length} / 1000 characters`;

    if (length > 950) {
      counter.classList.add('text-yellow-600', 'dark:text-yellow-400');
    } else if (length > 990) {
      counter.classList.add('text-red-600', 'dark:text-red-400');
    } else {
      counter.classList.remove('text-yellow-600', 'dark:text-yellow-400', 'text-red-600', 'dark:text-red-400');
    }
  });
}

function showApplicationForm() {
  document.getElementById('membership-form').parentElement.classList.remove('hidden');
  document.getElementById('success-section').classList.add('hidden');
  document.getElementById('error-section').classList.add('hidden');
}

async function submitApplication(event) {
  event.preventDefault();

  const submitBtn = document.getElementById('submit-btn');
  const originalText = submitBtn.textContent;
  const formSection = document.getElementById('membership-form').parentElement;

  // Disable button and show loading
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';
  submitBtn.classList.add('opacity-50');

  try {
    const formData = new FormData(event.target);

    const response = await fetch('/api/membership/apply', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        username: formData.get('username'),
        essay: formData.get('essay'),
        contact: formData.get('contact') || null
      })
    });

    const data = await response.json();

    if (response.ok && data.success) {
      // Hide form and show success
      formSection.classList.add('hidden');
      document.getElementById('success-section').classList.remove('hidden');

      // Display application ID
      if (data.application_id) {
        document.getElementById('application-id').textContent = data.application_id;
      }

      // Reset form
      event.target.reset();
      document.getElementById('essay-counter').textContent = '0 / 1000 characters';

      // Scroll to success message
      document.getElementById('success-section').scrollIntoView({ behavior: 'smooth' });

    } else {
      // Show error message
      document.getElementById('error-text').textContent = data.error || 'There was a problem submitting your application. Please try again.';
      formSection.classList.add('hidden');
      document.getElementById('error-section').classList.remove('hidden');
      document.getElementById('error-section').scrollIntoView({ behavior: 'smooth' });
    }

  } catch (error) {
    console.error('Application submission error:', error);
    document.getElementById('error-text').textContent = 'Network error. Please check your connection and try again.';
    formSection.classList.add('hidden');
    document.getElementById('error-section').classList.remove('hidden');
    document.getElementById('error-section').scrollIntoView({ behavior: 'smooth' });

  } finally {
    // Re-enable button
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
    submitBtn.classList.remove('opacity-50');
  }
}
</script>

<!-- SEO and Social Meta Tags -->
<meta name="description" content="Join the ThyWill prayer community - a faith-based community where members pray together, support one another, and experience God's love through authentic prayer fellowship.">
<meta property="og:title" content="Join ThyWill - Prayer Community Application">
<meta property="og:description" content="Apply to join our faith-based prayer community where we support each other through prayer and fellowship.">
<meta property="og:type" content="website">

{% endblock %}