{% extends "base.html" %}
{% block title %}Prayer Feed{% endblock %}

{% block content %}
<!-- Feed Navigation -->
<section class="mb-6">
  <nav class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
    <a href="/?feed_type=all" 
       class="px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-2 {% if current_feed == 'all' %}bg-white text-purple-700 shadow-sm{% else %}text-gray-600 hover:text-gray-900 hover:bg-gray-50{% endif %}">
      All Prayers
      <span class="bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded-full">{{ feed_counts.all or 0 }}</span>
    </a>
    <a href="/?feed_type=new_unprayed" 
       class="px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-2 {% if current_feed == 'new_unprayed' %}bg-white text-purple-700 shadow-sm{% else %}text-gray-600 hover:text-gray-900 hover:bg-gray-50{% endif %}">
      New & Unprayed
      {% if feed_counts.new_unprayed > 0 %}
        <span class="bg-red-100 text-red-700 text-xs px-2 py-0.5 rounded-full">{{ feed_counts.new_unprayed }}</span>
      {% else %}
        <span class="bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded-full">0</span>
      {% endif %}
    </a>
    <a href="/?feed_type=most_prayed" 
       class="px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-2 {% if current_feed == 'most_prayed' %}bg-white text-purple-700 shadow-sm{% else %}text-gray-600 hover:text-gray-900 hover:bg-gray-50{% endif %}">
      Most Prayed
      <span class="bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded-full">{{ feed_counts.most_prayed or 0 }}</span>
    </a>
    <a href="/?feed_type=my_prayers" 
       class="px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-2 {% if current_feed == 'my_prayers' %}bg-white text-purple-700 shadow-sm{% else %}text-gray-600 hover:text-gray-900 hover:bg-gray-50{% endif %}">
      My Prayers
      <span class="bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded-full">{{ feed_counts.my_prayers or 0 }}</span>
    </a>
    <a href="/?feed_type=my_requests" 
       class="px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-2 {% if current_feed == 'my_requests' %}bg-white text-purple-700 shadow-sm{% else %}text-gray-600 hover:text-gray-900 hover:bg-gray-50{% endif %}">
      My Requests
      <span class="bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded-full">{{ feed_counts.my_requests or 0 }}</span>
    </a>
    <a href="/?feed_type=recent_activity" 
       class="px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-2 {% if current_feed == 'recent_activity' %}bg-white text-purple-700 shadow-sm{% else %}text-gray-600 hover:text-gray-900 hover:bg-gray-50{% endif %}">
      Recent Activity
      <span class="bg-gray-200 text-gray-700 text-xs px-2 py-0.5 rounded-full">{{ feed_counts.recent_activity or 0 }}</span>
    </a>
    <a href="/activity" 
       class="px-3 py-2 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-900 hover:bg-gray-50">
      Activity Feed
    </a>
  </nav>
</section>

<!-- Prompt of the day -->
<section class="mb-8 bg-yellow-100 border-l-4 border-yellow-400 p-4 rounded">
  <h2 class="font-semibold text-lg mb-1">Today's Prompt</h2>
  <p>{{ prompt }}</p>
</section>

<!-- Generate invite link -->
<section class="mb-6 bg-white p-4 rounded shadow" id="invite-area">
  <button hx-post="/invites"
          hx-swap="outerHTML"
          class="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-green-500">
    Generate new invite link
  </button>
</section>

<!-- Submit new prayer -->
<section class="mb-10 bg-white p-6 rounded shadow">
  <h2 class="font-semibold mb-3">Add a Prayer Request</h2>
  <p class="text-sm text-gray-600 mb-4">Share your prayer request, and we'll craft a beautiful prayer for the community.</p>
  <form method="post" action="/prayers" class="space-y-4">
    <div>
      <label for="text" class="sr-only">Prayer request</label>
      <textarea id="text" name="text" rows="3" maxlength="500" required
        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
        placeholder="What would you like to pray for today?"></textarea>
    </div>
    <div>
      <label for="tag" class="sr-only">Project tag (optional)</label>
      <input id="tag" name="tag" placeholder="#Milestone (optional)" class="w-full border border-gray-300 rounded px-3 py-2" />
    </div>
    <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-purple-500">
      Submit Prayer Request
    </button>
  </form>
</section>

<!-- Prayer list -->
<section>
  {% if current_feed == "new_unprayed" %}
    <h2 class="font-semibold mb-2">New & Unprayed Requests</h2>
    <p class="text-sm text-gray-600 mb-4">Prayer requests that need your attention - new submissions and prayers that haven't been prayed by anyone yet.</p>
  {% elif current_feed == "most_prayed" %}
    <h2 class="font-semibold mb-2">Most Prayed Prayers</h2>
    <p class="text-sm text-gray-600 mb-4">The prayers that have touched the most hearts in our community.</p>
  {% elif current_feed == "my_prayers" %}
    <h2 class="font-semibold mb-2">Prayers I've Prayed</h2>
    <p class="text-sm text-gray-600 mb-4">All the prayers you've marked as prayed, ordered by when you last prayed them.</p>
  {% elif current_feed == "my_requests" %}
    <h2 class="font-semibold mb-2">My Prayer Requests</h2>
    <p class="text-sm text-gray-600 mb-4">Prayer requests you've submitted to the community.</p>
  {% elif current_feed == "recent_activity" %}
    <h2 class="font-semibold mb-2">Recent Prayer Activity</h2>
    <p class="text-sm text-gray-600 mb-4">Prayers that have been recently prayed by the community.</p>
  {% else %}
    <h2 class="font-semibold mb-4">Community Prayers</h2>
  {% endif %}
  <ul class="space-y-6">
    {% for p in prayers %}
    <li id="prayer-{{ p.id }}" class="bg-white p-6 rounded-lg shadow border-l-4 border-purple-300">
      <!-- Generated Prayer (prominent) -->
      {% if p.generated_prayer %}
      <div class="mb-4">
        <h3 class="text-sm font-medium text-purple-600 mb-2">ğŸ™ Prayer</h3>
        <p class="text-lg leading-relaxed text-gray-800 whitespace-pre-wrap italic">{{ p.generated_prayer }}</p>
      </div>
      {% endif %}
      
      <!-- Original Request (smaller, secondary) -->
      <div class="bg-gray-50 p-3 rounded border-l-2 border-gray-300">
        <h4 class="text-xs font-medium text-gray-500 mb-1">Original Request</h4>
        <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ p.text }}</p>
      </div>
      
      <footer class="mt-4 text-xs text-gray-500 flex justify-between items-center">
        <span>by {{ 'you' if p.author_id == me.id else p.author_name }} Â· {{ p.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
        <div class="flex items-center gap-4">
          <!-- Prayer mark section -->
          <div id="prayer-marks-{{ p.id }}" class="flex items-center gap-2">
            {% if p.mark_count > 0 %}
              {% if p.distinct_user_count == 1 %}
                {% if p.mark_count == 1 %}
                  <a href="/prayer/{{ p.id }}/marks" class="text-purple-600 hover:text-purple-800 hover:underline">ğŸ™ 1 person prayed this once</a>
                {% else %}
                  <a href="/prayer/{{ p.id }}/marks" class="text-purple-600 hover:text-purple-800 hover:underline">ğŸ™ 1 person prayed this {{ p.mark_count }} times</a>
                {% endif %}
              {% else %}
                <a href="/prayer/{{ p.id }}/marks" class="text-purple-600 hover:text-purple-800 hover:underline">ğŸ™ {{ p.distinct_user_count }} people prayed this {{ p.mark_count }} times</a>
              {% endif %}
            {% endif %}
            
            <form method="post" action="/mark/{{ p.id }}" class="inline">
              <button hx-post="/mark/{{ p.id }}" 
                      hx-target="#prayer-marks-{{ p.id }}"
                      hx-swap="innerHTML"
                      type="submit" 
                      class="bg-purple-100 hover:bg-purple-200 text-purple-700 text-xs px-2 py-1 rounded border border-purple-300 focus:outline-none focus:ring-1 focus:ring-purple-500">
                Mark as Prayed
              </button>
            </form>
            
            {% if p.marked_by_user > 0 %}
              {% if p.marked_by_user == 1 %}
                <span class="text-green-600 text-xs bg-green-100 px-2 py-1 rounded border border-green-300">âœ“ You prayed this</span>
              {% else %}
                <span class="text-green-600 text-xs bg-green-100 px-2 py-1 rounded border border-green-300">âœ“ You prayed this {{ p.marked_by_user }} times</span>
              {% endif %}
            {% endif %}
          </div>
          
          {% if me.id == 'admin' %}
            <a href="/flag/{{ p.id }}" class="text-red-600 hover:underline">Flag</a>
          {% endif %}
        </div>
      </footer>
    </li>
    {% else %}
    <li class="text-center py-8">
      {% if current_feed == "new_unprayed" %}
        <p class="text-gray-500 mb-2">Great news! All prayers have been prayed for.</p>
        <p class="text-sm text-gray-400">Check back later for new prayer requests that need attention.</p>
      {% elif current_feed == "most_prayed" %}
        <p class="text-gray-500 mb-2">No prayers have been marked as prayed yet.</p>
        <p class="text-sm text-gray-400">Be the first to pray for someone's request!</p>
      {% elif current_feed == "my_prayers" %}
        <p class="text-gray-500 mb-2">You haven't marked any prayers as prayed yet.</p>
        <p class="text-sm text-gray-400">Visit the <a href="/?feed_type=all" class="text-purple-600 hover:underline">All Prayers</a> feed to start praying.</p>
      {% elif current_feed == "my_requests" %}
        <p class="text-gray-500 mb-2">You haven't submitted any prayer requests yet.</p>
        <p class="text-sm text-gray-400">Use the form above to share what's on your heart.</p>
      {% elif current_feed == "recent_activity" %}
        <p class="text-gray-500 mb-2">No recent prayer activity.</p>
        <p class="text-sm text-gray-400">Check the <a href="/?feed_type=all" class="text-purple-600 hover:underline">All Prayers</a> feed to start praying.</p>
      {% else %}
        <p class="text-gray-500">No prayers yet. Be the first to lift one up.</p>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
</section>
{% endblock %}
