{% extends "base.html" %}
{% block title %}Prayer Feed{% endblock %}

{% block content %}
<!-- Compact Header with Main Actions -->
<section class="mb-6">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <!-- Page Title -->
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Community Prayers</h1>
      <p class="text-sm text-gray-600">Join our community in prayer</p>
    </div>
    
    <!-- Quick Actions -->
    <div class="flex flex-col sm:flex-row gap-2">
      <!-- Compact invite button -->
      <div id="invite-area">
        <button hx-post="/invites"
                hx-target="body"
                hx-swap="beforeend"
                class="text-sm bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-green-500">
          üìß Invite Someone
        </button>
      </div>
      
      <!-- Add prayer button that toggles form -->
      <button onclick="toggleAddPrayer()" 
              class="text-sm bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-purple-500">
        ‚úèÔ∏è Add Prayer Request
      </button>
    </div>
  </div>
</section>

<!-- Collapsible Add Prayer Form -->
<section id="add-prayer-form" class="mb-6 bg-white border border-gray-200 rounded-lg overflow-hidden" style="display: none;">
  <div class="p-4 bg-gray-50 border-b border-gray-200">
    <h2 class="font-semibold text-lg">Share Your Prayer Request</h2>
    <p class="text-sm text-gray-600">Tell us what's on your heart, and we'll craft a beautiful prayer for the community.</p>
  </div>
  <div class="p-4">
    <form method="post" action="/prayers" class="space-y-4">
      <div>
        <label for="text" class="sr-only">Prayer request</label>
        <textarea id="text" name="text" rows="3" maxlength="500" required
          class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
          placeholder="What would you like to pray for today?"></textarea>
      </div>
      <div>
        <label for="tag" class="sr-only">Project tag (optional)</label>
        <input id="tag" name="tag" placeholder="#Milestone (optional)" class="w-full border border-gray-300 rounded px-3 py-2" />
      </div>
      <div class="flex gap-2">
        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-4 py-2 rounded focus:outline-none focus:ring-2 focus:ring-purple-500">
          Submit Prayer Request
        </button>
        <button type="button" onclick="toggleAddPrayer()" class="text-gray-600 hover:text-gray-800 px-4 py-2 rounded">
          Cancel
        </button>
      </div>
    </form>
  </div>
</section>

<!-- Compact Feed Navigation -->
<section class="mb-6">
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-1">
    <nav class="flex overflow-x-auto scrollbar-hide space-x-1" style="scrollbar-width: none; -ms-overflow-style: none;">
      <style>
        .scrollbar-hide::-webkit-scrollbar {
          display: none;
        }
      </style>
      
      <a href="/?feed_type=all" 
         class="flex-shrink-0 inline-flex items-center gap-1.5 px-2 py-1.5 text-sm font-medium rounded-md transition-all duration-200 {% if current_feed == 'all' %}bg-purple-100 text-purple-700 shadow-sm{% else %}text-gray-600 hover:text-gray-900 hover:bg-gray-50{% endif %}">
        <span>All</span>
        <span class="inline-flex items-center justify-center w-4 h-4 text-xs font-semibold {% if current_feed == 'all' %}bg-purple-200 text-purple-800{% else %}bg-gray-200 text-gray-700{% endif %} rounded-full">{{ feed_counts.all or 0 }}</span>
      </a>
      
      <a href="/?feed_type=new_unprayed" 
         class="flex-shrink-0 inline-flex items-center gap-1.5 px-2 py-1.5 text-sm font-medium rounded-md transition-all duration-200 {% if current_feed == 'new_unprayed' %}bg-purple-100 text-purple-700 shadow-sm{% else %}text-gray-600 hover:text-gray-900 hover:bg-gray-50{% endif %}">
        <span>New</span>
        {% if feed_counts.new_unprayed > 0 %}
          <span class="inline-flex items-center justify-center w-4 h-4 text-xs font-semibold bg-red-100 text-red-700 rounded-full animate-pulse">{{ feed_counts.new_unprayed }}</span>
        {% else %}
          <span class="inline-flex items-center justify-center w-4 h-4 text-xs font-semibold {% if current_feed == 'new_unprayed' %}bg-purple-200 text-purple-800{% else %}bg-gray-200 text-gray-700{% endif %} rounded-full">0</span>
        {% endif %}
      </a>
      
      <a href="/?feed_type=most_prayed" 
         class="flex-shrink-0 inline-flex items-center gap-1.5 px-2 py-1.5 text-sm font-medium rounded-md transition-all duration-200 {% if current_feed == 'most_prayed' %}bg-purple-100 text-purple-700 shadow-sm{% else %}text-gray-600 hover:text-gray-900 hover:bg-gray-50{% endif %}">
        <span>Popular</span>
        <span class="inline-flex items-center justify-center w-4 h-4 text-xs font-semibold {% if current_feed == 'most_prayed' %}bg-purple-200 text-purple-800{% else %}bg-gray-200 text-gray-700{% endif %} rounded-full">{{ feed_counts.most_prayed or 0 }}</span>
      </a>
      
      <a href="/?feed_type=my_prayers" 
         class="flex-shrink-0 inline-flex items-center gap-1.5 px-2 py-1.5 text-sm font-medium rounded-md transition-all duration-200 {% if current_feed == 'my_prayers' %}bg-purple-100 text-purple-700 shadow-sm{% else %}text-gray-600 hover:text-gray-900 hover:bg-gray-50{% endif %}">
        <span>My Prayers</span>
        <span class="inline-flex items-center justify-center w-4 h-4 text-xs font-semibold {% if current_feed == 'my_prayers' %}bg-purple-200 text-purple-800{% else %}bg-gray-200 text-gray-700{% endif %} rounded-full">{{ feed_counts.my_prayers or 0 }}</span>
      </a>
      
      <a href="/?feed_type=my_requests" 
         class="flex-shrink-0 inline-flex items-center gap-1.5 px-2 py-1.5 text-sm font-medium rounded-md transition-all duration-200 {% if current_feed == 'my_requests' %}bg-purple-100 text-purple-700 shadow-sm{% else %}text-gray-600 hover:text-gray-900 hover:bg-gray-50{% endif %}">
        <span>My Prayer Requests</span>
        <span class="inline-flex items-center justify-center w-4 h-4 text-xs font-semibold {% if current_feed == 'my_requests' %}bg-purple-200 text-purple-800{% else %}bg-gray-200 text-gray-700{% endif %} rounded-full">{{ feed_counts.my_requests or 0 }}</span>
      </a>
      
      <a href="/?feed_type=recent_activity" 
         class="flex-shrink-0 inline-flex items-center gap-1.5 px-2 py-1.5 text-sm font-medium rounded-md transition-all duration-200 {% if current_feed == 'recent_activity' %}bg-purple-100 text-purple-700 shadow-sm{% else %}text-gray-600 hover:text-gray-900 hover:bg-gray-50{% endif %}">
        <span>Recent</span>
        <span class="inline-flex items-center justify-center w-4 h-4 text-xs font-semibold {% if current_feed == 'recent_activity' %}bg-purple-200 text-purple-800{% else %}bg-gray-200 text-gray-700{% endif %} rounded-full">{{ feed_counts.recent_activity or 0 }}</span>
      </a>
      
      <div class="flex-shrink-0 w-px bg-gray-300 mx-2 self-stretch"></div>
      
      <a href="/profile" 
         class="flex-shrink-0 inline-flex items-center gap-1.5 px-2 py-1.5 text-sm font-medium rounded-md transition-all duration-200 text-gray-600 hover:text-gray-900 hover:bg-gray-50">
        <span>My Profile</span>
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
      </a>
      
      <a href="/users" 
         class="flex-shrink-0 inline-flex items-center gap-1.5 px-2 py-1.5 text-sm font-medium rounded-md transition-all duration-200 text-gray-600 hover:text-gray-900 hover:bg-gray-50">
        <span>Community</span>
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0"></path>
        </svg>
      </a>
      
      <a href="/activity" 
         class="flex-shrink-0 inline-flex items-center gap-1.5 px-2 py-1.5 text-sm font-medium rounded-md transition-all duration-200 text-gray-600 hover:text-gray-900 hover:bg-gray-50">
        <span>Activity</span>
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
        </svg>
      </a>
    </nav>
  </div>
  
  <!-- Scroll hint for mobile -->
  <div class="flex justify-center mt-2 sm:hidden">
    <div class="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded-full">
      ‚Üê Swipe to see more tabs ‚Üí
    </div>
  </div>
</section>

<!-- Today's Prompt (moved to be more subtle) -->
{% if prompt %}
<section class="mb-6 bg-amber-50 border border-amber-200 p-3 rounded">
  <div class="flex items-start gap-2">
    <span class="text-amber-600 mt-0.5">üí°</span>
    <div>
      <h2 class="font-medium text-sm text-amber-800 mb-1">Today's Reflection</h2>
      <p class="text-sm text-amber-700">{{ prompt }}</p>
    </div>
  </div>
</section>
{% endif %}

<!-- Prayer list (now the main focus) -->
<section>
  {% if current_feed == "new_unprayed" %}
    <h2 class="font-semibold mb-2">New & Unprayed Requests</h2>
    <p class="text-sm text-gray-600 mb-4">Prayer requests that need your attention - new submissions and prayers that haven't been prayed by anyone yet.</p>
  {% elif current_feed == "most_prayed" %}
    <h2 class="font-semibold mb-2">Most Prayed Prayers</h2>
    <p class="text-sm text-gray-600 mb-4">The prayers that have touched the most hearts in our community.</p>
  {% elif current_feed == "my_prayers" %}
    <h2 class="font-semibold mb-2">Prayers I've Prayed</h2>
    <p class="text-sm text-gray-600 mb-4">All the prayers you've marked as prayed, ordered by when you last prayed them.</p>
  {% elif current_feed == "my_requests" %}
    <h2 class="font-semibold mb-2">My Prayer Requests</h2>
    <p class="text-sm text-gray-600 mb-4">Prayer requests you've submitted to the community.</p>
  {% elif current_feed == "recent_activity" %}
    <h2 class="font-semibold mb-2">Recent Prayer Activity</h2>
    <p class="text-sm text-gray-600 mb-4">Prayers that have been recently prayed by the community.</p>
  {% endif %}
  
  <ul class="space-y-6">
    {% for p in prayers %}
    <li id="prayer-{{ p.id }}" class="bg-white p-6 rounded-lg shadow border-l-4 border-purple-300">
      <!-- Generated Prayer (prominent) -->
      {% if p.generated_prayer %}
      <div class="mb-4">
        <h3 class="text-sm font-medium text-purple-600 mb-2">üôè Prayer</h3>
        <p class="text-lg leading-relaxed text-gray-800 whitespace-pre-wrap italic">{{ p.generated_prayer }}</p>
      </div>
      {% endif %}
      
      <!-- Original Request (smaller, secondary) -->
      <div class="bg-gray-50 p-3 rounded border-l-2 border-gray-300">
        <h4 class="text-xs font-medium text-gray-500 mb-1">Original Request</h4>
        <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ p.text }}</p>
      </div>
      
      <footer class="mt-4 text-xs text-gray-500 flex justify-between items-center">
        <span>by {% if p.author_id == me.id %}you{% else %}<a href="/user/{{ p.author_id }}" class="text-purple-600 hover:text-purple-800 hover:underline">{{ p.author_name }}</a>{% endif %} ¬∑ {{ p.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
        <div class="flex items-center gap-4">
          <!-- Prayer mark section -->
          <div id="prayer-marks-{{ p.id }}" class="flex items-center gap-2">
            {% if p.mark_count > 0 %}
              {% if p.distinct_user_count == 1 %}
                {% if p.mark_count == 1 %}
                  <a href="/prayer/{{ p.id }}/marks" class="text-purple-600 hover:text-purple-800 hover:underline">üôè 1 person prayed this once</a>
                {% else %}
                  <a href="/prayer/{{ p.id }}/marks" class="text-purple-600 hover:text-purple-800 hover:underline">üôè 1 person prayed this {{ p.mark_count }} times</a>
                {% endif %}
              {% else %}
                <a href="/prayer/{{ p.id }}/marks" class="text-purple-600 hover:text-purple-800 hover:underline">üôè {{ p.distinct_user_count }} people prayed this {{ p.mark_count }} times</a>
              {% endif %}
            {% endif %}
            
            <form method="post" action="/mark/{{ p.id }}" class="inline">
              <button hx-post="/mark/{{ p.id }}" 
                      hx-target="#prayer-marks-{{ p.id }}"
                      hx-swap="innerHTML"
                      type="submit" 
                      class="bg-purple-100 hover:bg-purple-200 text-purple-700 text-xs px-2 py-1 rounded border border-purple-300 focus:outline-none focus:ring-1 focus:ring-purple-500">
                Mark as Prayed
              </button>
            </form>
            
            {% if p.marked_by_user > 0 %}
              {% if p.marked_by_user == 1 %}
                <span class="text-green-600 text-xs bg-green-100 px-2 py-1 rounded border border-green-300">‚úì You prayed this</span>
              {% else %}
                <span class="text-green-600 text-xs bg-green-100 px-2 py-1 rounded border border-green-300">‚úì You prayed this {{ p.marked_by_user }} times</span>
              {% endif %}
            {% endif %}
          </div>
          
          <form method="post" action="/flag/{{ p.id }}" class="inline">
            <button type="submit" 
                    hx-post="/flag/{{ p.id }}"
                    hx-target="#prayer-{{ p.id }}"
                    hx-swap="outerHTML"
                    hx-indicator="#loading-{{ p.id }}"
                    class="text-red-600 hover:text-red-800 hover:underline text-xs px-1 py-0.5 rounded transition-colors duration-200">
              <span class="htmx-indicator" id="loading-{{ p.id }}">üîÑ</span>
              <span>Flag</span>
            </button>
          </form>
        </div>
      </footer>
    </li>
    {% else %}
    <li class="text-center py-8">
      {% if current_feed == "new_unprayed" %}
        <p class="text-gray-500 mb-2">Great news! All prayers have been prayed for.</p>
        <p class="text-sm text-gray-400">Check back later for new prayer requests that need attention.</p>
      {% elif current_feed == "most_prayed" %}
        <p class="text-gray-500 mb-2">No prayers have been marked as prayed yet.</p>
        <p class="text-sm text-gray-400">Be the first to pray for someone's request!</p>
      {% elif current_feed == "my_prayers" %}
        <p class="text-gray-500 mb-2">You haven't marked any prayers as prayed yet.</p>
        <p class="text-sm text-gray-400">Visit the <a href="/?feed_type=all" class="text-purple-600 hover:underline">All Prayers</a> feed to start praying.</p>
      {% elif current_feed == "my_requests" %}
        <p class="text-gray-500 mb-2">You haven't submitted any prayer requests yet.</p>
        <p class="text-sm text-gray-400">Click the "Add Prayer Request" button above to share what's on your heart.</p>
      {% elif current_feed == "recent_activity" %}
        <p class="text-gray-500 mb-2">No recent prayer activity.</p>
        <p class="text-sm text-gray-400">Check the <a href="/?feed_type=all" class="text-purple-600 hover:underline">All Prayers</a> feed to start praying.</p>
      {% else %}
        <p class="text-gray-500 mb-2">No prayers yet. Be the first to lift one up.</p>
        <p class="text-sm text-gray-400">Click "Add Prayer Request" above to get started.</p>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
</section>

<script>
function toggleAddPrayer() {
    const form = document.getElementById('add-prayer-form');
    const isVisible = form.style.display !== 'none';
    
    if (isVisible) {
        form.style.display = 'none';
    } else {
        form.style.display = 'block';
        // Focus on the textarea when opening
        setTimeout(() => {
            document.getElementById('text').focus();
        }, 100);
    }
}

// Close form after successful submission
document.addEventListener('DOMContentLoaded', function() {
    // Check if there's a success message (you could add this logic)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('submitted') === 'true') {
        document.getElementById('add-prayer-form').style.display = 'none';
    }
});

// Invite modal functions
function closeInviteModal() {
    const modal = document.getElementById('invite-modal');
    if (modal) {
        modal.remove();
    }
}

function copyInviteLink(url) {
    navigator.clipboard.writeText(url).then(function() {
        // Show temporary success feedback
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '‚úì Copied!';
        button.classList.remove('bg-purple-600', 'hover:bg-purple-700');
        button.classList.add('bg-green-600', 'hover:bg-green-700');
        
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('bg-green-600', 'hover:bg-green-700');
            button.classList.add('bg-purple-600', 'hover:bg-purple-700');
        }, 2000);
    }).catch(function() {
        // Fallback: select the text for manual copying
        const linkElement = document.querySelector('#invite-modal a');
        if (linkElement) {
            const range = document.createRange();
            range.selectNode(linkElement);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
        }
    });
}

// Close modal when clicking on backdrop
document.addEventListener('click', function(event) {
    const modal = document.getElementById('invite-modal');
    if (modal && event.target === modal) {
        closeInviteModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeInviteModal();
    }
});
</script>
{% endblock %}
